<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWRPG Datapad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Shapes */
        .shape-hex { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
        .shape-rhombus { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); transform: scale(1.15); }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .rank-box { transition: all 0.1s ease; }
        .rank-box:hover { transform: scale(1.2); z-index: 10; border-color: #fbbf24; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .mini-btn { @apply w-5 h-5 flex items-center justify-center rounded bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold leading-none border border-slate-600 transition cursor-pointer active:scale-95; }
        .compact-select { @apply bg-slate-900 border-none text-xs font-bold text-yellow-500 focus:ring-0 cursor-pointer hover:bg-slate-800 rounded px-2 py-1 transition w-full sm:w-auto; appearance: none; text-align-last: center; sm:text-align-last: right; }

        /* Section Divider */
        .section-divider { @apply relative flex py-2 items-center; }
        .section-divider::before, .section-divider::after { content: ''; @apply flex-grow border-t border-slate-800; }
        .section-title { @apply mx-2 sm:mx-4 text-[10px] uppercase tracking-widest font-bold text-slate-500 bg-slate-950 px-2 font-mono flex items-center gap-2 whitespace-nowrap; }
/* === ИСПРАВЛЕНИЕ ЦВЕТОВ SELECT === */
        
        /* 1. Красим само поле (когда список свернут) */
        .compact-select {
            background-color: #0f172a !important; /* Темный фон (Slate-900) */
            color: #eab308 !important;            /* Желтый текст */
            border: 1px solid #1e293b !important; /* Тонкая темная рамка */
        }

        /* 2. Красим выпадающие пункты (когда список развернут) */
        .compact-select option {
            background-color: #0f172a;
            color: #eab308;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans min-h-screen flex flex-col selection:bg-yellow-900 selection:text-white">

    <!-- HEADER & CONFIG -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-50 shadow-lg backdrop-blur-md bg-opacity-90">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2">
            
            <!-- Top Row: Logo & Tabs -->
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-1.5 h-5 sm:w-2 sm:h-6 bg-yellow-500 skew-x-[-12deg] shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div>
                    <h1 class="text-xs sm:text-sm font-bold uppercase tracking-[0.1em] sm:tracking-[0.2em] text-white">
                        Star Wars <span class="text-yellow-500 opacity-80 block sm:inline text-[9px] sm:text-sm leading-none sm:leading-normal">Datapad</span>
                    </h1>
                </div>
                <div class="flex bg-slate-800 rounded-md p-0.5">
                    <button onclick="switchTab('generator')" id="btn-generator" class="px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold transition-all bg-slate-700 text-white shadow">Лист</button>
                    <button onclick="switchTab('editor')" id="btn-editor" class="px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold transition-all hover:bg-slate-700 text-slate-400">База</button>
                </div>
            </div>
            
            <!-- Config Bar (Responsive Grid/Flex) -->
            <div id="config-bar" class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-2 bg-slate-950/50 p-2 sm:p-1.5 rounded border border-slate-800 text-xs">
                
                <div class="relative group w-10 h-10 sm:w-12 sm:h-12 flex-shrink-0 mx-auto sm:mx-0 z-20">
                    <div id="avatar-display" onclick="handleAvatarClick(event)" 
                         class="w-full h-full rounded-full border border-slate-700 bg-slate-900 bg-cover bg-center cursor-pointer overflow-hidden flex items-center justify-center hover:border-yellow-500 transition shadow-lg shadow-black/50 relative z-0">
                        <svg id="avatar-placeholder" class="text-slate-700 w-1/2 h-1/2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    
                    <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
                    
                    <div id="avatar-menu" class="hidden absolute top-full mt-2 left-0 bg-slate-900 border border-slate-700 rounded shadow-xl flex flex-col overflow-hidden min-w-[120px] z-50 fade-in">
                        <button onclick="actionReplace()" class="px-3 py-2 text-[10px] text-slate-300 hover:text-white hover:bg-slate-800 text-left border-b border-slate-800 transition w-full flex items-center gap-2">
                            <span>↻</span> Заменить
                        </button>
                        <button onclick="actionDelete()" class="px-3 py-2 text-[10px] text-red-400 hover:text-red-300 hover:bg-slate-800 text-left transition w-full flex items-center gap-2">
                            <span>×</span> Удалить
                        </button>
                    </div>
                </div>

                <div class="flex-grow w-full sm:w-auto min-w-[150px] relative group">
                    <input type="text" id="char-name" value="Имя Персонажа" class="w-full bg-transparent border-none text-white font-bold text-lg px-1 sm:px-2 focus:ring-0 placeholder-slate-600 focus:text-yellow-400 transition-colors text-center sm:text-left">
                    <div class="absolute bottom-0 left-2 right-2 h-[1px] bg-slate-700 group-hover:bg-slate-500 transition-colors"></div>
                </div>
                
                <div class="grid grid-cols-3 sm:flex sm:items-center gap-2 w-full sm:w-auto">
                    <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 bg-slate-900 rounded px-1 sm:px-2 py-1 border border-slate-800">
                        <label class="uppercase font-bold text-[8px] sm:text-[9px] text-slate-500">Раса</label>
                        <select id="gen-race" class="compact-select"></select>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 bg-slate-900 rounded px-1 sm:px-2 py-1 border border-slate-800">
                        <label class="uppercase font-bold text-[8px] sm:text-[9px] text-slate-500">Карьера</label>
                        <select id="gen-career" class="compact-select"></select>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 bg-slate-900 rounded px-1 sm:px-2 py-1 border border-slate-800">
                        <label class="uppercase font-bold text-[8px] sm:text-[9px] text-slate-500">Спец.</label>
                        <select id="gen-spec" class="compact-select"></select>
                    </div>
                </div>

                <div class="flex flex-wrap items-center justify-between sm:justify-end gap-2 w-full sm:w-auto mt-1 sm:mt-0">
                    
                    <div class="flex items-center gap-2 bg-slate-900 rounded px-2 py-1 border border-slate-800 flex-grow sm:flex-grow-0 min-w-[120px]">
                        <div class="flex flex-col gap-0.5 w-full">
                            <div class="flex justify-between items-end w-full">
                                <label class="uppercase font-bold text-[8px] sm:text-[9px] text-slate-500 leading-none">Мораль</label>
                                <span id="morality-status" class="text-[8px] uppercase font-bold text-slate-500 leading-none truncate max-w-[80px]">Равновесие</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="morality-val" value="50" min="1" max="100" class="w-6 sm:w-8 bg-transparent text-xs text-center font-bold outline-none text-white border-b border-slate-700 focus:border-white transition-colors" onchange="updateMorality(this.value)">
                                <div class="w-full h-1.5 sm:h-2 bg-gradient-to-r from-red-950 via-red-900 to-red-700 rounded-full overflow-hidden border border-slate-700 relative shadow-inner shadow-red-950/50">
                                    <div class="absolute top-0 bottom-0 w-px bg-white/20 z-10" style="left: 30%"></div>
                                    <div class="absolute top-0 bottom-0 w-px bg-white/20 z-10" style="left: 70%"></div>
                                    <div id="morality-bar" class="h-full w-1/2 transition-all duration-500 ease-out bg-gradient-to-r from-blue-100 to-white shadow-[0_0_10px_rgba(255,255,255,0.7)]"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col justify-between bg-slate-900 rounded px-2 py-1 border border-slate-800 h-full min-w-[40px]">
                        <label class="uppercase font-bold text-[8px] sm:text-[9px] text-blue-400 leading-none text-center">Сила</label>
                        <div class="relative flex items-center justify-center h-full">
                             <svg class="absolute w-6 h-6 text-blue-500/20 pointer-events-none" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>
                             <input type="number" id="force-rating" value="1" min="0" max="10" class="relative z-10 w-8 bg-transparent text-center font-black text-white text-sm outline-none border-b border-transparent focus:border-blue-500 transition-colors" onchange="updateForce(this.value)">
                        </div>
                    </div>

                    <div class="flex items-center gap-2 bg-slate-900 rounded px-2 py-1 border border-slate-800 shadow-lg h-full relative group sm:ml-auto">
                        <div class="flex flex-col items-end mr-1 justify-center cursor-help relative">
                            <span class="text-[8px] uppercase font-bold text-slate-500 leading-none border-b border-dotted border-slate-600">XP</span>
                            <span class="text-[8px] text-slate-600 font-mono leading-none mt-0.5">Всего: <span id="xp-total-display" class="text-slate-400">0</span></span>
                            <div id="xp-log-tooltip" class="hidden group-hover:block absolute top-full right-0 mt-2 w-32 bg-slate-950 border border-slate-700 rounded shadow-xl p-1 z-50 pointer-events-none sm:pointer-events-auto">
                                <div class="text-[8px] uppercase text-slate-500 font-bold mb-1 text-center border-b border-slate-800 pb-1">История</div>
                                <ul id="xp-log-list" class="space-y-0.5 max-h-32 overflow-hidden"></ul>
                            </div>
                        </div>
                        <div class="text-2xl font-black text-yellow-500 leading-none drop-shadow-md" id="xp-avail-display">0</div>
                        <div class="flex items-center gap-1 bg-slate-950 rounded border border-slate-700 p-0.5 h-full">
                            <input type="number" id="xp-amount-input" class="w-8 bg-transparent text-center text-xs font-bold text-white outline-none placeholder-slate-700 h-full" placeholder="0">
                            <div class="flex flex-col justify-between h-full gap-px">
                                <button onclick="applyXP('add')" class="w-4 flex-1 bg-green-900/30 hover:bg-green-600 text-green-500 hover:text-white rounded-[1px] flex items-center justify-center text-[8px] leading-none transition" title="Начислить">+</button>
                                <button onclick="applyXP('spend')" class="w-4 flex-1 bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white rounded-[1px] flex items-center justify-center text-[8px] leading-none transition" title="Потратить">-</button>
                            </div>
                        </div>
                        <button onclick="undoLastXP()" id="btn-xp-undo" class="text-slate-600 hover:text-white transition disabled:opacity-20 ml-1 h-full flex items-center" disabled title="Отменить">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-1 border-l border-slate-800 pl-2">
                         <div class="relative group">
                            <button onclick="saveCharacter()" class="p-1.5 hover:text-green-400 text-slate-500 transition"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                            <div class="hidden sm:block absolute right-0 top-full mt-1 px-2 py-1 bg-slate-800 border border-slate-700 rounded text-[9px] text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg">Сохранить</div>
                        </div>
                        <label class="p-1.5 hover:text-blue-400 text-slate-500 transition cursor-pointer flex items-center">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <input type="file" onchange="loadCharacter(this)" class="hidden" accept=".json">
                        </label>
                        <button onclick="window.print()" class="p-1.5 hover:text-white text-slate-500 transition" title="Печать">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        </button>
                    </div>

                </div>
            </div>
            
            <div class="flex justify-center sm:justify-between items-center px-1 mt-1">
                <div id="gen-race-info" class="text-[9px] text-yellow-500/70 truncate max-w-full sm:max-w-md text-center sm:text-left"></div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-2 sm:p-4 relative space-y-6 sm:space-y-8">
        
        <!-- === TAB: GENERATOR === -->
        <div id="tab-generator" class="fade-in space-y-6 sm:space-y-8">

            <!-- CHARACTERISTICS (Responsive Grid: 2 cols mobile, 3 cols tablet+) -->
            <div>
                <div class="section-divider"><span class="section-title">Характеристики</span></div>
                <div id="gen-stats-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3"></div>
            </div>

            <!-- VITALS & XP -->
            <div>
                <div class="section-divider"><span class="section-title">Состояние</span></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    <!-- Wounds -->
                    <div id="card-wounds" class="bg-slate-900 p-3 rounded border border-red-900/30 flex flex-col justify-between h-36 sm:h-40 relative overflow-hidden shadow-lg shadow-black/20"></div>
                    <!-- Strain -->
                    <div id="card-strain" class="bg-slate-900 p-3 rounded border border-blue-900/30 flex flex-col justify-between h-36 sm:h-40 relative overflow-hidden shadow-lg shadow-black/20"></div>
                    <!-- Soak -->
                    <div class="bg-slate-900 p-2 rounded border border-slate-700 shadow-lg shadow-black/20 h-36 sm:h-40 grid grid-cols-5 gap-2 relative overflow-hidden">
                        
                        <div class="col-span-2 flex flex-col justify-between border-r border-slate-800 pr-2">
                            <div class="flex justify-between items-start">
                                <div class="text-[9px] uppercase font-bold text-slate-500 tracking-wider leading-tight">Поглощение</div>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-slate-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                            <div class="flex-grow flex items-center justify-center">
                                 <div class="text-4xl sm:text-5xl font-black text-white" id="val-soak">0</div>
                            </div>
                            <div class="text-center">
                                <label class="text-[8px] uppercase font-bold text-slate-500 block mb-0.5">Броня</label>
                                <input type="number" id="val-armor" value="0" min="0" class="w-full bg-slate-950 border border-slate-600 rounded p-0.5 text-center text-xs text-white focus:border-yellow-500 outline-none transition-colors">
                            </div>
                        </div>

                        <div class="col-span-3 flex flex-col h-full relative">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-[9px] uppercase font-bold text-red-500 tracking-wider">Крит. Раны</div>
                                <button onclick="addCrit()" class="w-4 h-4 bg-red-900/30 hover:bg-red-500 text-red-500 hover:text-white rounded flex items-center justify-center text-[10px] transition font-bold" title="Добавить рану">+</button>
                            </div>
                            
                            <div id="crit-list" class="flex-col gap-1 overflow-y-auto custom-scrollbar h-full pr-1 space-y-1">
                                </div>
                            
                            <div id="crit-empty" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
                                <svg class="w-10 h-10 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- SKILLS (Responsive Grid: 1 col mobile, 3 cols desktop) -->
            <div>
                <div class="section-divider">
                    <span class="section-title">Навыки 
                        <span class="text-[8px] text-slate-600 ml-2 font-normal font-sans border border-slate-800 px-1 rounded bg-slate-900/50">
                            Рангов: <span id="total-ranks-display" class="text-yellow-500 font-bold">0</span>
                        </span>
                    </span>
                </div>
                
                <div id="skill-mobile-tabs" class="flex lg:hidden bg-slate-900 rounded p-1 border border-slate-800 mb-2">
                    <button onclick="toggleMobileSkills('gen')" id="tab-btn-gen" class="flex-1 py-1.5 text-[10px] font-bold uppercase rounded bg-slate-700 text-white shadow transition">
                        Общие
                    </button>
                    <button onclick="toggleMobileSkills('com')" id="tab-btn-com" class="flex-1 py-1.5 text-[10px] font-bold uppercase rounded hover:bg-slate-800 text-slate-500 transition">
                        Боевые
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 h-auto min-h-[600px] lg:h-[calc(100vh-500px)]">
                    
                    <div id="view-skills-gen" class="lg:col-span-2 bg-slate-900 rounded border border-slate-800 flex flex-col overflow-hidden shadow-lg shadow-black/20 h-[400px] lg:h-auto block lg:flex">
                        
                        <div class="bg-slate-950 border-b border-slate-800 flex items-center text-[8px] uppercase font-bold text-slate-500 sticky top-0 z-10 h-9">
                            <div class="w-6 text-center flex-shrink-0"></div>
                            <div class="flex-grow px-2 flex items-center gap-3">
                                <span class="text-slate-400 text-[10px] tracking-widest">Общие</span>
                                <div class="flex gap-2 opacity-50 font-normal">
                                    <span class="text-green-500 flex items-center gap-0.5"><span class="border border-green-900 bg-green-900/20 w-3 h-3 flex items-center justify-center rounded-[1px] text-[6px]">К</span></span>
                                    <span class="text-blue-400 flex items-center gap-0.5"><span class="border border-blue-900 bg-blue-900/20 w-3 h-3 flex items-center justify-center rounded-[1px] text-[6px]">С</span></span>
                                </div>
                            </div>
                            <div class="w-20 pl-2 flex-shrink-0">Ранг</div>
                            <div class="w-24 text-right pr-4 flex-shrink-0">Пул</div>
                        </div>

                        <div class="overflow-y-auto flex-grow custom-scrollbar">
                            <table class="w-full text-xs text-left">
                                <tbody id="gen-skills-general-body" class="divide-y divide-slate-800/50"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="view-skills-com" class="bg-slate-900 rounded border border-slate-800 flex flex-col overflow-hidden shadow-lg shadow-black/20 h-auto lg:h-auto hidden lg:flex">
                        
                        <div class="bg-red-950/20 border-b border-red-900/20 flex items-center text-[8px] uppercase font-bold text-red-400/70 sticky top-0 z-10 h-9">
                            <div class="w-6 text-center flex-shrink-0"></div>
                            <div class="flex-grow px-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                                <span class="tracking-widest text-[10px] text-red-400">Боевые</span>
                            </div>
                            <div class="w-20 pl-2 flex-shrink-0">Ранг</div>
                            <div class="w-24 text-right pr-4 flex-shrink-0">Пул</div>
                        </div>

                        <div class="overflow-y-auto flex-grow custom-scrollbar">
                            <table class="w-full text-xs text-left">
                                <tbody id="gen-skills-combat-body" class="divide-y divide-slate-800/50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        <!-- === TAB: EDITOR === -->
        <div id="tab-editor" class="hidden fade-in h-full">
            <div class="flex flex-col sm:flex-row justify-between items-center bg-slate-900 p-2 rounded border border-slate-800 mb-4 gap-2">
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="setEditorMode('races')" id="btn-edit-races" class="flex-1 sm:flex-none px-3 py-1 text-xs font-bold uppercase rounded bg-yellow-600 text-white">Расы</button>
                    <button onclick="setEditorMode('careers')" id="btn-edit-careers" class="flex-1 sm:flex-none px-3 py-1 text-xs font-bold uppercase rounded bg-slate-800 hover:bg-slate-700 text-slate-300">Карьеры</button>
                </div>
                <div class="flex gap-2 w-full sm:w-auto justify-end">
                    <button onclick="resetDatabase()" class="text-[10px] text-red-500 hover:text-red-400 underline px-2">СБРОС БАЗЫ</button>
                    <button onclick="exportData()" class="px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-[10px] text-white border border-slate-700">Скачать</button>
                    <label class="px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-[10px] text-white border border-slate-700 cursor-pointer">Загрузить <input type="file" onchange="importData(this)" class="hidden" accept=".json"></label>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-200px)]">
                <div class="bg-slate-900 border border-slate-800 rounded flex flex-col h-[300px] lg:h-auto">
                    <div class="p-2 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                        <h3 class="text-xs font-bold uppercase text-slate-400" id="editor-list-title">Список</h3>
                        <button onclick="addNewItem()" class="w-5 h-5 bg-green-700 hover:bg-green-600 rounded text-white flex items-center justify-center font-bold text-xs">+</button>
                    </div>
                    <div id="editor-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
                </div>
                <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded p-4 overflow-y-auto relative h-auto">
                    <div id="editor-form-placeholder" class="h-full flex flex-col items-center justify-center text-slate-600 text-sm"><p>Выберите элемент</p></div>
                    <form id="editor-form" class="hidden space-y-4" onsubmit="event.preventDefault(); saveCurrentItem();">
                        <input type="hidden" id="edit-id">
                        <div><label class="block text-[10px] uppercase font-bold text-slate-500">Название</label><input type="text" id="edit-name" class="w-full bg-slate-950 border border-slate-700 rounded p-2 focus:border-yellow-500 outline-none text-sm text-white" required></div>
                        <div id="form-race-fields" class="hidden space-y-4">
                             <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-center">
                                <div class="space-y-1"><label class="text-[9px] text-red-400 font-bold">СИЛ</label><input type="number" min="1" max="6" id="edit-brawn" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                                <div class="space-y-1"><label class="text-[9px] text-green-400 font-bold">ЛОВ</label><input type="number" min="1" max="6" id="edit-agility" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                                <div class="space-y-1"><label class="text-[9px] text-blue-400 font-bold">ИНТ</label><input type="number" min="1" max="6" id="edit-intellect" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                                <div class="space-y-1"><label class="text-[9px] text-yellow-400 font-bold">СМК</label><input type="number" min="1" max="6" id="edit-cunning" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                                <div class="space-y-1"><label class="text-[9px] text-purple-400 font-bold">VOL</label><input type="number" min="1" max="6" id="edit-willpower" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                                <div class="space-y-1"><label class="text-[9px] text-pink-400 font-bold">HAR</label><input type="number" min="1" max="6" id="edit-presence" class="w-full bg-slate-950 border border-slate-700 p-1 text-center rounded text-sm"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="text-[9px] text-slate-500 block">Раны</label><input type="number" id="edit-baseWounds" class="w-full bg-slate-950 border border-slate-700 p-1 rounded text-sm"></div>
                                <div><label class="text-[9px] text-slate-500 block">Усталость</label><input type="number" id="edit-baseStrain" class="w-full bg-slate-950 border border-slate-700 p-1 rounded text-sm"></div>
                                <div><label class="text-[9px] text-slate-500 block">XP</label><input type="number" id="edit-startXP" class="w-full bg-slate-950 border border-slate-700 p-1 rounded text-sm"></div>
                            </div>
                            <div><label class="text-[9px] text-slate-500 block">Особенности</label><textarea id="edit-special" class="w-full bg-slate-950 border border-slate-700 p-2 rounded h-16 text-xs"></textarea></div>
                        </div>
                        <div id="form-career-fields" class="hidden space-y-4">
                            <div><label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Навыки</label><div id="edit-career-skills-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-1 text-[10px] bg-slate-950 p-2 rounded border border-slate-800 max-h-32 overflow-y-auto"></div></div>
                            <div class="border-t border-slate-800 pt-2"><div class="flex justify-between items-center mb-1"><label class="block text-[10px] uppercase font-bold text-slate-300">Специализации</label><button type="button" onclick="addSpecialization()" class="text-[9px] bg-blue-700 hover:bg-blue-600 px-2 py-0.5 rounded text-white">Add</button></div><div id="specs-container" class="space-y-2"></div></div>
                        </div>
                        <div class="flex justify-end pt-2 border-t border-slate-800 gap-2"><button type="button" onclick="deleteCurrentItem()" class="px-3 py-1 text-red-500 hover:text-red-400 text-xs">Удалить</button><button type="submit" class="px-4 py-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded text-xs">Сохранить</button></div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- JS LOGIC -->
    <script>
        const COMBAT_SKILLS_LIST = ["Световой меч", "Драка", "Холодное оружие", "Артиллерия", "Стрельба (Лёгкое)", "Стрельба (Тяжёлое)"];
        const ALL_SKILLS = [
            { name: "Астронавигация", char: "intellect" }, { name: "Атлетика", char: "brawn" }, 
            { name: "Внимательность", char: "cunning" }, { name: "Воровство", char: "cunning" }, 
            { name: "Выживание", char: "cunning" }, { name: "Готовность", char: "willpower" }, 
            { name: "Запугивание", char: "willpower" }, { name: "Знание (Вселенная)", char: "intellect" }, 
            { name: "Знание (Внешнее кольцо)", char: "intellect" }, { name: "Знание (Война)", char: "intellect" }, 
            { name: "Знание (Преступность)", char: "intellect" }, { name: "Компьютеры", char: "intellect" }, 
            { name: "Координация", char: "agility" }, { name: "Лидерство", char: "presence" }, 
            { name: "Медицина", char: "intellect" }, { name: "Механика", char: "intellect" }, 
            { name: "Обаяние", char: "presence" }, { name: "Обман", char: "cunning" }, 
            { name: "Переговоры", char: "presence" }, { name: "Пилотирование (Космос)", char: "agility" }, 
            { name: "Пилотирование (Планетарное)", char: "agility" }, { name: "Скрытность", char: "agility" }, 
            { name: "Стойкость", char: "brawn" }, { name: "Уличное чутьё", char: "cunning" }, 
            { name: "Хладнокровие", char: "presence" }, 
            { name: "Артиллерия", char: "agility" }, { name: "Драка", char: "brawn" }, 
            { name: "Стрельба (Лёгкое)", char: "agility" }, { name: "Стрельба (Тяжёлое)", char: "agility" }, 
            { name: "Холодное оружие", char: "brawn" }, { name: "Световой меч", char: "brawn" } 
        ].sort((a,b) => a.name.localeCompare(b.name));

        const STAT_CONFIG = {
            brawn: { t: "Физ. сила", color: "text-red-500", border: "border-red-900/50", bg: "bg-red-950/10" },
            agility: { t: "Ловкость", color: "text-green-500", border: "border-green-900/50", bg: "bg-green-950/10" },
            intellect: { t: "Интеллект", color: "text-blue-500", border: "border-blue-900/50", bg: "bg-blue-950/10" },
            cunning: { t: "Смекалка", color: "text-yellow-500", border: "border-yellow-900/50", bg: "bg-yellow-950/10" },
            willpower: { t: "Воля", color: "text-purple-500", border: "border-purple-900/50", bg: "bg-purple-950/10" },
            presence: { t: "Харизма", color: "text-orange-500", border: "border-orange-900/50", bg: "bg-orange-950/10" }
        };

        const DEFAULT_DB = {
            races: [
                { id: "bothan", name: "Ботан", stats: { brawn: 1, agility: 2, intellect: 2, cunning: 3, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 11, startXP: 100, special: "Уличное чутьё +1 ранг" },
                { id: "wookiee", name: "Вуки", stats: { brawn: 3, agility: 2, intellect: 2, cunning: 2, willpower: 1, presence: 2 }, baseWounds: 14, baseStrain: 8, startXP: 90, special: "Ярость вуки (+урон)" },
                { id: "gand", name: "Ганды", stats: { brawn: 2, agility: 2, intellect: 2, cunning: 2, willpower: 3, presence: 1 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "" },
                { id: "gran", name: "Гран", stats: { brawn: 2, agility: 2, intellect: 2, cunning: 1, willpower: 2, presence: 3 }, baseWounds: 10, baseStrain: 9, startXP: 100, special: "" },
                { id: "droid", name: "Дроиды", stats: { brawn: 1, agility: 1, intellect: 1, cunning: 1, willpower: 1, presence: 1 }, baseWounds: 10, baseStrain: 10, startXP: 175, special: "Механическое тело, не нужен воздух" },
                { id: "duros", name: "Дурос", stats: { brawn: 1, agility: 2, intellect: 3, cunning: 2, willpower: 2, presence: 2 }, baseWounds: 11, baseStrain: 10, startXP: 100, special: "Пилотирование +1 ранг" },
                { id: "zabrak", name: "Забрак", stats: { brawn: 2, agility: 2, intellect: 2, cunning: 2, willpower: 3, presence: 1 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "Выживание +1 ранг" },
                { id: "ithorian", name: "Иторианец", stats: { brawn: 2, agility: 1, intellect: 2, cunning: 2, willpower: 3, presence: 2 }, baseWounds: 9, baseStrain: 12, startXP: 90, special: "Звуковой удар" },
                { id: "keldor", name: "Кел-дор", stats: { brawn: 1, agility: 2, intellect: 2, cunning: 2, willpower: 3, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "Видит в темноте, нужна маска" },
                { id: "human", name: "Человек", stats: { brawn: 2, agility: 2, intellect: 2, cunning: 2, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 110, special: "+1 ранг в 2 любых навыках" },
                { id: "mirialan", name: "Мириалан", stats: { brawn: 2, agility: 3, intellect: 2, cunning: 1, willpower: 2, presence: 2 }, baseWounds: 11, baseStrain: 10, startXP: 100, special: "Дисциплина +1 ранг" },
                { id: "moncalamari", name: "Мон Каламари", stats: { brawn: 2, agility: 2, intellect: 3, cunning: 1, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "Дышит под водой" },
                { id: "nautolan", name: "Наутолан", stats: { brawn: 3, agility: 2, intellect: 2, cunning: 2, willpower: 1, presence: 2 }, baseWounds: 11, baseStrain: 9, startXP: 100, special: "Дышит под водой" },
                { id: "rodian", name: "Родиан", stats: { brawn: 2, agility: 3, intellect: 2, cunning: 2, willpower: 1, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "Выживание +1 ранг" },
                { id: "sullustan", name: "Сулустан", stats: { brawn: 2, agility: 3, intellect: 2, cunning: 1, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "" },
                { id: "togruta", name: "Тогрута", stats: { brawn: 1, agility: 2, intellect: 2, cunning: 3, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 10, startXP: 100, special: "Стайная тактика" },
                { id: "twilek", name: "Тви'лек", stats: { brawn: 1, agility: 2, intellect: 2, cunning: 2, willpower: 2, presence: 3 }, baseWounds: 10, baseStrain: 11, startXP: 100, special: "Устойчивость к жаре, Обаяние +1" },
                { id: "trandoshan", name: "Трандошан", stats: { brawn: 3, agility: 1, intellect: 2, cunning: 2, willpower: 2, presence: 2 }, baseWounds: 12, baseStrain: 9, startXP: 90, special: "Регенерация" },
                { id: "cerean", name: "Цереане", stats: { brawn: 2, agility: 1, intellect: 3, cunning: 2, willpower: 2, presence: 2 }, baseWounds: 10, baseStrain: 13, startXP: 90, special: "Инициатива +1 ранг" }
            ],
            careers: [
                { id: "mystic", name: "Мистик", careerSkills: ["Обаяние", "Запугивание", "Знание (Вселенная)", "Знание (Внешнее кольцо)", "Внимательность", "Готовность"], specializations: [{ id: "seer", name: "Провидец", bonusSkills: ["Знание (Вселенная)", "Внимательность", "Готовность", "Уличное чутьё"] }, { id: "advisor", name: "Советник", bonusSkills: ["Обаяние", "Переговоры", "Знание (Вселенная)", "Лидерство"] }] },
                { id: "soldier", name: "Солдат", careerSkills: ["Атлетика", "Драка", "Стрельба (Лёгкое)", "Стрельба (Тяжёлое)", "Выживание", "Запугивание", "Внимательность", "Знание (Война)"], specializations: [{ id: "sharpshooter", name: "Снайпер", bonusSkills: ["Внимательность", "Хладнокровие", "Стрельба (Тяжёлое)", "Стрельба (Лёгкое)"] }, { id: "commando", name: "Коммандо", bonusSkills: ["Драка", "Стойкость", "Холодное оружие", "Выживание"] }] },
                { id: "smuggler", name: "Контрабандист", careerSkills: ["Координация", "Обман", "Внимательность", "Пилотирование (Космос)", "Скрытность", "Уличное чутьё", "Внимательность", "Знание (Преступность)"], specializations: [{ id: "scoundrel", name: "Прохвост", bonusSkills: ["Обаяние", "Хладнокровие", "Обман", "Стрельба (Лёгкое)"] }] }
            ]
        };

        let db = JSON.parse(JSON.stringify(DEFAULT_DB));
        let editorMode = "races";
        let currentEditItem = null;
        let statMods = { brawn: 0, agility: 0, intellect: 0, cunning: 0, willpower: 0, presence: 0 };
        let thresholdMods = { wounds: 0, strain: 0 };
        let currentStatus = { wounds: 0, strain: 0 };
        let xpData = { earned: 0, spent: 0 }; 
        let xpHistory = []; 
        let xpLog = []; 
        let skillRanks = {}; 
        let morality = 50; 

        window.onload = function() { loadDatabase(); initGenerator(); switchTab('generator'); updateMorality(50); };

        function switchTab(tab) {
            document.getElementById('tab-generator').classList.add('hidden');
            document.getElementById('tab-editor').classList.add('hidden');
            document.getElementById('btn-generator').className = "px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold transition-all hover:bg-slate-700 text-slate-400";
            document.getElementById('btn-editor').className = "px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold transition-all hover:bg-slate-700 text-slate-400";
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).className = "px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold transition-all bg-slate-700 text-white shadow";
            if(tab === 'editor') setEditorMode('races'); 
            if(tab === 'generator') initGenerator(); 
        }

        function loadDatabase() { const saved = localStorage.getItem('swrpg_db_v3'); if (saved) { try { db = JSON.parse(saved); } catch(e) { db = JSON.parse(JSON.stringify(DEFAULT_DB)); } } }
        function saveDatabase() { localStorage.setItem('swrpg_db_v3', JSON.stringify(db)); }
        function resetDatabase() { if(confirm("Вы уверены?")) { localStorage.removeItem('swrpg_db_v3'); db = JSON.parse(JSON.stringify(DEFAULT_DB)); setEditorMode(editorMode); initGenerator(); alert("Сброс!"); } }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const a = document.createElement('a'); a.href = dataStr; a.download = "swrpg_db.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { db = JSON.parse(e.target.result); saveDatabase(); setEditorMode(editorMode); alert("Загружено!"); } catch(err) { alert("Ошибка!"); } }; reader.readAsText(file); }

        function initGenerator() {
            const raceSel = document.getElementById('gen-race');
            const careerSel = document.getElementById('gen-career');
            const prevRace = raceSel.value; const prevCareer = careerSel.value;
            raceSel.innerHTML = ""; careerSel.innerHTML = "";
            db.races.forEach(r => { const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name; raceSel.appendChild(opt); });
            db.careers.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; careerSel.appendChild(opt); });
            if(prevRace && db.races.find(r=>r.id===prevRace)) raceSel.value = prevRace;
            if(prevCareer && db.careers.find(c=>c.id===prevCareer)) careerSel.value = prevCareer;
            raceSel.onchange = () => { resetStatMods(); updateGeneratorUI(); };
            careerSel.onchange = updateSpecsAndUI;
            document.getElementById('gen-spec').onchange = updateGeneratorUI;
            document.getElementById('val-armor').oninput = updateGeneratorUI;
            updateSpecsAndUI();
        }

        function resetStatMods() {
            statMods = { brawn: 0, agility: 0, intellect: 0, cunning: 0, willpower: 0, presence: 0 };
            thresholdMods = { wounds: 0, strain: 0 };
            currentStatus = { wounds: 0, strain: 0 };
            xpData = { earned: 0, spent: 0 }; 
            xpHistory = []; xpLog = [];
            skillRanks = {}; 
            morality = 50; updateMorality(50);
        }

        function updateSpecsAndUI() {
            const careerId = document.getElementById('gen-career').value;
            const career = db.careers.find(c => c.id === careerId);
            const specSel = document.getElementById('gen-spec');
            specSel.innerHTML = "";
            if (career && career.specializations) {
                career.specializations.forEach(s => { const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; specSel.appendChild(opt); });
            }
            updateGeneratorUI();
        }

        function modifyStat(statKey, delta) {
            const race = db.races.find(r => r.id === document.getElementById('gen-race').value);
            if (!race) return;
            const newVal = race.stats[statKey] + (statMods[statKey] || 0) + delta;
            if (newVal >= 1 && newVal <= 7) { statMods[statKey] = (statMods[statKey] || 0) + delta; updateGeneratorUI(); }
        }
        function modifyThreshold(type, delta) { thresholdMods[type] += delta; updateGeneratorUI(); }
        function modifyCurrent(type, delta) { currentStatus[type] = Math.max(0, currentStatus[type] + delta); updateGeneratorUI(); }

        // --- MORALITY LOGIC (DUAL COLOR) ---
        function updateMorality(val) {
            // Считаем значение, но не даем ему выйти за границы 1-100 для внутренней логики
            morality = Math.min(100, Math.max(1, parseInt(val) || 1));
            
            const bar = document.getElementById('morality-bar');
            const input = document.getElementById('morality-val');
            const statusLabel = document.getElementById('morality-status'); 
            
            // !!! ГЛАВНОЕ ИСПРАВЛЕНИЕ:
            // Менять значение в поле можно ТОЛЬКО если пользователь НЕ печатает в нем прямо сейчас.
            // Это позволяет стирать цифры полностью и писать новые без помех.
            if (document.activeElement !== input) {
                input.value = morality;
            }

            bar.style.width = morality + '%';
            
            // Логика текста (Светлая/Темная сторона)
            let status = "Равновесие";
            let textClass = "text-slate-500";

            if (morality <= 10) {
                status = "Тьма: Эффект 2";
                textClass = "text-red-500 font-black animate-pulse";
            } else if (morality <= 20) {
                status = "Тьма: Эффект 1";
                textClass = "text-red-400 font-bold";
            } else if (morality <= 30) {
                status = "Тёмная сторона";
                textClass = "text-red-300";
            } else if (morality >= 90) {
                status = "Свет: Эффект 2";
                textClass = "text-blue-100 font-black animate-pulse shadow-white";
            } else if (morality >= 80) {
                status = "Свет: Эффект 1";
                textClass = "text-blue-200 font-bold";
            } else if (morality >= 70) {
                status = "Светлая сторона";
                textClass = "text-blue-300";
            } else {
                status = "Равновесие";
                textClass = "text-slate-500";
            }

            if(statusLabel) {
                statusLabel.textContent = status;
                statusLabel.className = `text-[8px] uppercase font-bold ml-2 transition-colors leading-none ${textClass}`;
            }
        }

        function applyXP(action) {
            const inputId = action === 'add' ? 'xp-add-input' : 'xp-spend-input';
            const val = parseInt(document.getElementById(inputId).value) || 0;
            
            if (val !== 0) {
                xpHistory.push({ earned: xpData.earned, spent: xpData.spent, log: [...xpLog] });
                if (xpHistory.length > 10) xpHistory.shift();

                let logEntry = "";
                if (action === 'add') {
                    xpData.earned += val;
                    logEntry = val > 0 ? `<span class="text-green-500">+${val} Награда</span>` : `<span class="text-red-400">${val} Коррекция</span>`;
                } else if (action === 'spend') {
                    xpData.spent += val;
                    logEntry = val > 0 ? `<span class="text-red-400">-${val} Трата</span>` : `<span class="text-green-500">+${Math.abs(val)} Возврат</span>`;
                }
                
                xpLog.unshift(logEntry);
                if (xpLog.length > 3) xpLog.pop();

                document.getElementById(inputId).value = '';
                updateGeneratorUI();
            }
        }

        function undoLastXP() {
            if (xpHistory.length === 0) return;
            const state = xpHistory.pop();
            xpData.earned = state.earned;
            xpData.spent = state.spent;
            xpLog = state.log;
            updateGeneratorUI();
        }

        function renderXPLogDisplay() {
            const list = document.getElementById('xp-log-list');
            list.innerHTML = "";
            if (xpLog.length === 0) {
                list.innerHTML = `<li class="text-[9px] text-slate-600 italic text-center mt-2">Нет записей</li>`;
            } else {
                xpLog.forEach(entry => {
                    list.innerHTML += `<li class="text-[9px] font-mono flex justify-between border-b border-slate-800/50 pb-0.5 last:border-0">${entry}</li>`;
                });
            }
            
            const tooltip = document.getElementById('undo-tooltip');
            if (xpHistory.length > 0) {
                const lastState = xpHistory[xpHistory.length - 1];
                tooltip.textContent = "Отменить последнее";
            }
        }

        function setSkillRank(skillName, rank) {
            const current = skillRanks[skillName] || 0;
            if (current === rank) skillRanks[skillName] = 0; else skillRanks[skillName] = rank;
            updateGeneratorUI();
        }
        function toggleSkillDie(skillName, type) {
            const current = skillRanks[skillName] || 0;
            if(type==='green') skillRanks[skillName] = current + 1;
            else if(type==='yellow') skillRanks[skillName] = Math.max(0, current - 1);
            else if(type==='empty') skillRanks[skillName] = current + 1;
            updateGeneratorUI();
        }

        function renderSkillRow(skill, finalStats, isCareer, isSpec) {
            const charVal = finalStats[skill.char];
            const rank = skillRanks[skill.name] || 0;
            const totalPool = Math.max(charVal, rank);
            const yellow = Math.min(charVal, rank);
            const green = totalPool - yellow;
            const displayLimit = Math.max(totalPool + 1, 6); 

            let icon = "";
            let rowClass = "hover:bg-slate-800/50 transition border-l-2 border-transparent"; 

            if (isSpec) {
                icon = `<div class="w-4 h-4 rounded-sm bg-blue-500/20 border border-blue-500 text-blue-400 flex items-center justify-center text-[9px] font-bold cursor-help" title="Навык специализации (Карьерный)">С</div>`;
                rowClass = "bg-blue-900/10 border-l-2 border-blue-500 hover:bg-slate-800/50 transition";
            } else if (isCareer) {
                icon = `<div class="w-4 h-4 rounded-sm bg-green-500/20 border border-green-500 text-green-400 flex items-center justify-center text-[9px] font-bold cursor-help" title="Карьерный навык">К</div>`;
                rowClass = "bg-green-900/10 border-l-2 border-green-500 hover:bg-slate-800/50 transition";
            } else {
                icon = `<div class="w-4 h-4 opacity-5"></div>`;
            }
            
            let rankHtml = '<div class="flex gap-0.5">';
            for(let i=1; i<=5; i++) {
                const filled = i <= rank;
                const bg = filled ? "bg-yellow-500 shadow-[0_0_5px_rgba(234,179,8,0.5)] border-yellow-600" : "bg-slate-800 border-slate-700 hover:bg-slate-700";
                rankHtml += `<div onclick="setSkillRank('${skill.name}', ${i})" class="rank-box w-2 h-3 rounded-[1px] border cursor-pointer ${bg}" title="Rank ${i}"></div>`;
            }
            rankHtml += '</div>';

            let poolHtml = '<div class="flex gap-0.5 items-center justify-end">';
            for(let i=0; i<displayLimit; i++) {
                if(i < yellow) poolHtml += `<div onclick="toggleSkillDie('${skill.name}', 'yellow')" class="shape-hex w-3 h-3 bg-yellow-400 border border-yellow-600 cursor-pointer hover:brightness-110"></div>`;
                else if(i < yellow + green) poolHtml += `<div onclick="toggleSkillDie('${skill.name}', 'green')" class="shape-rhombus w-3 h-3 bg-green-500 border border-green-600 cursor-pointer hover:brightness-110"></div>`;
                else if(i === yellow + green) poolHtml += `<div onclick="toggleSkillDie('${skill.name}', 'empty')" class="w-3 h-3 bg-slate-800 border border-slate-700 rounded-sm cursor-pointer hover:bg-slate-700 opacity-50 hover:opacity-100"></div>`;
                else poolHtml += `<div class="w-3 h-3 bg-transparent rounded-sm"></div>`;
            }
            poolHtml += '</div>';

            return `
                <tr class="${rowClass}">
                    <td class="p-2 text-center w-6">${icon}</td>
                    <td class="p-2 text-xs font-medium text-slate-300">
                        <div class="flex flex-col leading-none">
                            <span>${skill.name}</span>
                            <span class="text-[8px] text-slate-500 mt-0.5 uppercase">${STAT_CONFIG[skill.char].t} (${charVal})</span>
                        </div>
                    </td>
                    <td class="p-2 w-20">${rankHtml}</td>
                    <td class="p-2 w-24 text-right">${poolHtml}</td>
                </tr>
            `;
        }

        function updateGeneratorUI() {
            const race = db.races.find(r => r.id === document.getElementById('gen-race').value);
            const career = db.careers.find(c => c.id === document.getElementById('gen-career').value);
            const spec = career ? career.specializations.find(s => s.id === document.getElementById('gen-spec').value) : null;
            const armor = parseInt(document.getElementById('val-armor').value) || 0;
            if (!race) return;

            document.getElementById('gen-race-info').textContent = `XP: ${race.startXP} | ${race.special}`;

            const finalStats = {};
            const statsDiv = document.getElementById('gen-stats-grid');
            statsDiv.innerHTML = '';
            Object.keys(race.stats).forEach(key => {
                finalStats[key] = race.stats[key] + (statMods[key] || 0);
                const val = finalStats[key];
                const conf = STAT_CONFIG[key];
                const isModified = (statMods[key] || 0) > 0;
                const valueColor = isModified ? "text-yellow-400 drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]" : "text-white";
                const borderClass = isModified ? "border-yellow-500/60 shadow-[0_0_10px_rgba(234,179,8,0.1)]" : conf.border;

                statsDiv.innerHTML += `
                    <div class="stat-card relative flex flex-col items-center p-2 rounded border bg-slate-900 ${borderClass} overflow-hidden group">
                        <span class="text-[9px] uppercase font-black opacity-90 mb-0 leading-none ${conf.color}">${conf.t}</span>
                        <div class="flex items-center gap-2 z-20 mt-1">
                            <button onclick="modifyStat('${key}', -1)" class="w-4 h-4 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center font-bold text-[10px] shadow border border-slate-700 transition">-</button>
                            <span class="text-4xl font-black ${valueColor} z-10 w-8 text-center leading-none tracking-tighter transition-colors">${val}</span>
                            <button onclick="modifyStat('${key}', 1)" class="w-4 h-4 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center font-bold text-[10px] shadow border border-slate-700 transition">+</button>
                        </div>
                        <div class="absolute -bottom-2 -right-1 text-6xl opacity-5 font-black pointer-events-none ${conf.color}">${val}</div>
                    </div>`;
            });

            const totalXP = race.startXP + xpData.earned;
            const availXP = totalXP - xpData.spent;
            document.getElementById('xp-total-display').textContent = totalXP;
            document.getElementById('xp-avail-display').textContent = availXP;
            
            const undoBtn = document.getElementById('btn-xp-undo');
            undoBtn.disabled = xpHistory.length === 0;
            undoBtn.style.opacity = xpHistory.length === 0 ? '0.2' : '1';
            
            renderXPLogDisplay();

            const maxWounds = race.baseWounds + finalStats.brawn + thresholdMods.wounds;
            const maxStrain = race.baseStrain + finalStats.willpower + thresholdMods.strain;
            const woundPct = Math.min(100, (currentStatus.wounds / maxWounds) * 100);
            const strainPct = Math.min(100, (currentStatus.strain / maxStrain) * 100);

            document.getElementById('card-wounds').innerHTML = `
                <div class="flex justify-between items-start mb-1"><div class="flex items-center gap-1.5"><div class="p-1 bg-red-500/10 rounded-full text-red-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><div class="text-[9px] uppercase font-bold text-slate-500 tracking-wider">Раны</div></div><div class="flex items-center gap-1 text-[9px] font-mono text-slate-500">MAX <button onclick="modifyThreshold('wounds', -1)" class="mini-btn">-</button><span class="text-white font-bold w-3 text-center">${maxWounds}</span><button onclick="modifyThreshold('wounds', 1)" class="mini-btn">+</button></div></div>
                <div class="flex items-center justify-between gap-2 mb-2 flex-grow"><button onclick="modifyCurrent('wounds', -1)" class="w-8 h-8 rounded bg-slate-950 border border-slate-700 hover:border-green-500 text-slate-400 hover:text-green-500 font-bold text-lg transition flex items-center justify-center">-</button><div class="text-4xl font-black text-white">${currentStatus.wounds}</div><button onclick="modifyCurrent('wounds', 1)" class="w-8 h-8 rounded bg-slate-950 border border-slate-700 hover:border-red-500 text-slate-400 hover:text-red-500 font-bold text-lg transition flex items-center justify-center">+</button></div>
                <div class="w-full bg-slate-950 h-1.5 rounded-full overflow-hidden border border-slate-800"><div class="bg-red-600 h-full transition-all duration-300" style="width: ${woundPct}%"></div></div>`;

            document.getElementById('card-strain').innerHTML = `
                <div class="flex justify-between items-start mb-1"><div class="flex items-center gap-1.5"><div class="p-1 bg-blue-500/10 rounded-full text-blue-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div><div class="text-[9px] uppercase font-bold text-slate-500 tracking-wider">Усталость</div></div><div class="flex items-center gap-1 text-[9px] font-mono text-slate-500">MAX <button onclick="modifyThreshold('strain', -1)" class="mini-btn">-</button><span class="text-white font-bold w-3 text-center">${maxStrain}</span><button onclick="modifyThreshold('strain', 1)" class="mini-btn">+</button></div></div>
                <div class="flex items-center justify-between gap-2 mb-2 flex-grow"><button onclick="modifyCurrent('strain', -1)" class="w-8 h-8 rounded bg-slate-950 border border-slate-700 hover:border-green-500 text-slate-400 hover:text-green-500 font-bold text-lg transition flex items-center justify-center">-</button><div class="text-4xl font-black text-white">${currentStatus.strain}</div><button onclick="modifyCurrent('strain', 1)" class="w-8 h-8 rounded bg-slate-950 border border-slate-700 hover:border-blue-500 text-slate-400 hover:text-blue-500 font-bold text-lg transition flex items-center justify-center">+</button></div>
                <div class="w-full bg-slate-950 h-1.5 rounded-full overflow-hidden border border-slate-800"><div class="bg-blue-500 h-full transition-all duration-300" style="width: ${strainPct}%"></div></div>`;

            document.getElementById('val-soak').textContent = finalStats.brawn + armor;

            const generalTbody = document.getElementById('gen-skills-general-body');
            const combatTbody = document.getElementById('gen-skills-combat-body');
            generalTbody.innerHTML = ''; combatTbody.innerHTML = '';
            const careerSkills = new Set(career ? career.careerSkills : []);
            const specSkills = new Set(spec ? spec.bonusSkills : []);

            ALL_SKILLS.forEach(skill => {
                const isCombat = COMBAT_SKILLS_LIST.includes(skill.name);
                const html = renderSkillRow(skill, finalStats, careerSkills.has(skill.name), specSkills.has(skill.name));
                if(isCombat) combatTbody.innerHTML += html; else generalTbody.innerHTML += html;
            });

            // ADDED: Calculate Total Ranks
            const totalRanks = Object.values(skillRanks).reduce((a, b) => a + b, 0);
            const ranksDisplay = document.getElementById('total-ranks-display');
            if(ranksDisplay) ranksDisplay.textContent = totalRanks;
        }

        // ... Editor functions preserved ...
        function setEditorMode(mode) { editorMode = mode; renderEditorList(); hideEditorForm(); }
        function renderEditorList() { const list = document.getElementById('editor-list'); list.innerHTML = ""; (editorMode === 'races' ? db.races : db.careers).forEach(item => { list.innerHTML += `<div onclick="loadItemToForm('${item.id}')" class="p-2 bg-slate-800 hover:bg-slate-700 rounded cursor-pointer border border-transparent hover:border-slate-500 mb-1 flex justify-between"><span class="font-bold text-xs text-slate-300">${item.name}</span></div>`; }); }
        function hideEditorForm() { document.getElementById('editor-form').classList.add('hidden'); document.getElementById('editor-form-placeholder').classList.remove('hidden'); }
        function addNewItem() { const id = "c_"+Date.now(); if(editorMode==='races') db.races.push({id, name:"New Race", stats:{brawn:2,agility:2,intellect:2,cunning:2,willpower:2,presence:2},baseWounds:10,baseStrain:10,startXP:100,special:""}); else db.careers.push({id, name:"New Career", careerSkills:[], specializations:[{id:id+"_s", name:"Spec 1", bonusSkills:[]}]}); saveDatabase(); renderEditorList(); loadItemToForm(id); }
        function loadItemToForm(id) { 
            const items = editorMode === 'races' ? db.races : db.careers; 
            currentEditItem = items.find(i=>i.id===id); 
            if(!currentEditItem) return; 
            document.getElementById('editor-form-placeholder').classList.add('hidden');
            document.getElementById('editor-form').classList.remove('hidden');
            document.getElementById('edit-id').value = id; 
            document.getElementById('edit-name').value = currentEditItem.name;
            if(editorMode==='races') { 
                document.getElementById('form-race-fields').classList.remove('hidden'); document.getElementById('form-career-fields').classList.add('hidden'); 
                ['brawn','agility','intellect','cunning','willpower','presence'].forEach(k => document.getElementById('edit-'+k).value = currentEditItem.stats[k]);
                document.getElementById('edit-baseWounds').value = currentEditItem.baseWounds;
                document.getElementById('edit-baseStrain').value = currentEditItem.baseStrain;
                document.getElementById('edit-startXP').value = currentEditItem.startXP;
                document.getElementById('edit-special').value = currentEditItem.special;
            } else {
                document.getElementById('form-race-fields').classList.add('hidden'); document.getElementById('form-career-fields').classList.remove('hidden');
                const grid = document.getElementById('edit-career-skills-grid'); grid.innerHTML = ALL_SKILLS.map(s => `<label class="flex gap-1 items-center hover:bg-slate-800 p-0.5 rounded cursor-pointer"><input type="checkbox" class="career-skill-cb accent-yellow-600" value="${s.name}" ${currentEditItem.careerSkills.includes(s.name)?'checked':''}> <span class="text-slate-300">${s.name}</span></label>`).join('');
                document.getElementById('specs-container').innerHTML = currentEditItem.specializations.map((s,i) => `<div class="bg-slate-900 p-1.5 rounded border border-slate-700 flex gap-2 items-center"><input class="bg-slate-950 border border-slate-700 rounded px-1 w-full text-xs text-slate-300" value="${s.name}" onchange="currentEditItem.specializations[${i}].name=this.value;saveDatabase()"><button type="button" onclick="currentEditItem.specializations.splice(${i},1);saveDatabase();loadItemToForm('${id}')" class="text-red-500 hover:text-red-400 text-[10px]">Del</button></div>`).join('');
            }
        }
        function addSpecialization() { if(currentEditItem) { currentEditItem.specializations.push({id:Date.now(), name:"New Spec", bonusSkills:[]}); saveDatabase(); loadItemToForm(currentEditItem.id); } }
        function deleteCurrentItem() { if(currentEditItem && confirm("Delete?")) { if(editorMode==='races') db.races = db.races.filter(i=>i.id!==currentEditItem.id); else db.careers = db.careers.filter(i=>i.id!==currentEditItem.id); saveDatabase(); renderEditorList(); hideEditorForm(); } }
        function saveCurrentItem() { 
            if(!currentEditItem) return; 
            currentEditItem.name = document.getElementById('edit-name').value;
            if(editorMode==='races') {
                ['brawn','agility','intellect','cunning','willpower','presence'].forEach(k => currentEditItem.stats[k] = parseInt(document.getElementById('edit-'+k).value));
                currentEditItem.baseWounds = parseInt(document.getElementById('edit-baseWounds').value);
                currentEditItem.baseStrain = parseInt(document.getElementById('edit-baseStrain').value);
                currentEditItem.startXP = parseInt(document.getElementById('edit-startXP').value);
                currentEditItem.special = document.getElementById('edit-special').value;
            } else {
                currentEditItem.careerSkills = Array.from(document.querySelectorAll('.career-skill-cb:checked')).map(cb=>cb.value);
            }
            saveDatabase(); renderEditorList(); alert("Saved");
        }
    </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }

// ===========================================
// === ГЛАВНЫЙ СКРИПТ (FINAL FIX) ===
// ===========================================

    let isSaveReady = false; 
    let charAvatar = ""; 
    let forceRating = 1;
    let criticalInjuries = []; 

    // Функция переключения вкладок (дублируем сюда на всякий случай)
    function toggleMobileSkills(tab) {
        const viewGen = document.getElementById('view-skills-gen');
        const viewCom = document.getElementById('view-skills-com');
        const btnGen = document.getElementById('tab-btn-gen');
        const btnCom = document.getElementById('tab-btn-com');

        const activeClass = "bg-slate-700 text-white shadow";
        const inactiveClass = "hover:bg-slate-800 text-slate-500";

        if (tab === 'gen') {
            viewGen.classList.remove('hidden');
            viewCom.classList.add('hidden');
            if(btnGen) btnGen.className = "flex-1 py-1.5 text-[10px] font-bold uppercase rounded transition " + activeClass;
            if(btnCom) btnCom.className = "flex-1 py-1.5 text-[10px] font-bold uppercase rounded transition " + inactiveClass;
        } else {
            viewGen.classList.add('hidden');
            viewCom.classList.remove('hidden');
            if(btnGen) btnGen.className = "flex-1 py-1.5 text-[10px] font-bold uppercase rounded transition " + inactiveClass;
            if(btnCom) btnCom.className = "flex-1 py-1.5 text-[10px] font-bold uppercase rounded transition " + activeClass;
        }
    }

    // Логика XP
    function applyXP(action) {
        const input = document.getElementById('xp-amount-input'); 
        const val = parseInt(input.value) || 0;
        if (val !== 0) {
            xpHistory.push({ earned: xpData.earned, spent: xpData.spent, log: [...xpLog] });
            if (xpHistory.length > 10) xpHistory.shift();
            let logEntry = action === 'add' ? (val > 0 ? `+${val}` : `${val}`) : (val > 0 ? `-${val}` : `+${Math.abs(val)}`);
            if (action === 'add') xpData.earned += val; else xpData.spent += val;
            xpLog.unshift(logEntry);
            if (xpLog.length > 5) xpLog.pop();
            input.value = ''; updateGeneratorUI(); saveSession();
        }
    }
    function undoLastXP() {
        if (xpHistory.length === 0) return;
        const state = xpHistory.pop();
        xpData.earned = state.earned; xpData.spent = state.spent; xpLog = state.log;
        updateGeneratorUI(); saveSession();
    }
    function renderXPLogDisplay() {
        const list = document.getElementById('xp-log-list');
        if (list) {
            list.innerHTML = "";
            if (xpLog.length === 0) list.innerHTML = `<li class="text-[8px] text-slate-600 italic text-center">Пусто</li>`;
            else xpLog.forEach(e => list.innerHTML += `<li class="text-[8px] font-mono flex justify-between border-b border-slate-800/50 pb-0.5 last:border-0">${e}</li>`);
        }
        const btn = document.getElementById('btn-xp-undo');
        if(btn) { btn.disabled = xpHistory.length === 0; btn.style.opacity = xpHistory.length === 0 ? '0.2' : '1'; }
    }

    // Логика Силы и Ран
    function updateForce(val) { forceRating = Math.max(0, parseInt(val) || 0); const el = document.getElementById('force-rating'); if(el) el.value = forceRating; saveSession(); }
    function renderCrits() {
        const list = document.getElementById('crit-list'); const emptyMsg = document.getElementById('crit-empty');
        if (!list) return;
        list.innerHTML = "";
        if (criticalInjuries.length === 0) { if(emptyMsg) emptyMsg.classList.remove('hidden'); }
        else {
            if(emptyMsg) emptyMsg.classList.add('hidden');
            criticalInjuries.forEach((crit, index) => {
                const row = document.createElement('div'); row.className = "flex items-center gap-1 animate-fade-in";
                row.innerHTML = `<input type="text" class="w-full bg-slate-950 border border-slate-700 rounded px-1.5 py-0.5 text-[10px] text-red-300 placeholder-slate-700 focus:border-red-500 outline-none" value="${crit}" onchange="updateCrit(${index}, this.value)" placeholder="d100 эффект..."><button class="text-slate-600 hover:text-red-500 font-bold px-1" onclick="removeCrit(${index})">×</button>`;
                list.appendChild(row);
            });
        }
    }
    function addCrit() { if (criticalInjuries.length >= 4) { alert("Максимум 4!"); return; } criticalInjuries.push(""); renderCrits(); saveSession(); }
    function updateCrit(i, t) { criticalInjuries[i] = t; saveSession(); }
    function removeCrit(i) { if(confirm("Исцелить?")) { criticalInjuries.splice(i, 1); renderCrits(); saveSession(); } }

    // Аватар
    function handleAvatarClick(e) { e.stopPropagation(); const m = document.getElementById('avatar-menu'); if (!charAvatar) { document.getElementById('avatar-input').click(); m.classList.add('hidden'); } else m.classList.toggle('hidden'); }
    function actionReplace() { document.getElementById('avatar-menu').classList.add('hidden'); document.getElementById('avatar-input').click(); }
    function actionDelete() { document.getElementById('avatar-menu').classList.add('hidden'); if(confirm("Удалить?")) { charAvatar = ""; document.getElementById('avatar-input').value = ""; updateAvatarUI(); saveSession(); } }
    function uploadAvatar(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { charAvatar = e.target.result; updateAvatarUI(); saveSession(); document.getElementById('avatar-menu').classList.add('hidden'); }; reader.readAsDataURL(input.files[0]); } }
    function updateAvatarUI() { const div = document.getElementById('avatar-display'); const icon = document.getElementById('avatar-placeholder'); if (charAvatar) { div.style.backgroundImage = `url(${charAvatar})`; icon.classList.add('hidden'); } else { div.style.backgroundImage = 'none'; icon.classList.remove('hidden'); } }

    // Сохранение
    function saveSession() {
        if (!isSaveReady) return; 
        const session = {
            charName: document.getElementById('char-name').value,
            raceVal: document.getElementById('gen-race').value,
            careerVal: document.getElementById('gen-career').value,
            specVal: document.getElementById('gen-spec').value,
            armorVal: document.getElementById('val-armor').value,
            charAvatar: charAvatar, forceRating: forceRating, criticalInjuries: criticalInjuries,
            statMods: statMods, thresholdMods: thresholdMods, currentStatus: currentStatus,
            xpData: xpData, xpHistory: xpHistory, xpLog: xpLog, skillRanks: skillRanks, morality: morality
        };
        localStorage.setItem('swrpg_autosave_v1', JSON.stringify(session));
    }
    function loadSession() {
        const saved = localStorage.getItem('swrpg_autosave_v1');
        if (!saved) { isSaveReady = true; return; }
        try {
            const s = JSON.parse(saved);
            document.getElementById('char-name').value = s.charName || "Имя Персонажа";
            document.getElementById('val-armor').value = s.armorVal || 0;
            if (s.charAvatar) { charAvatar = s.charAvatar; updateAvatarUI(); }
            if (s.forceRating !== undefined) { forceRating = s.forceRating; const el = document.getElementById('force-rating'); if(el) el.value = forceRating; }
            if (s.criticalInjuries) { criticalInjuries = s.criticalInjuries; renderCrits(); }
            if(s.raceVal) document.getElementById('gen-race').value = s.raceVal;
            if(s.careerVal) document.getElementById('gen-career').value = s.careerVal;
            updateSpecsAndUI();
            if(s.specVal) document.getElementById('gen-spec').value = s.specVal;
            if(s.statMods) statMods = s.statMods;
            if(s.thresholdMods) thresholdMods = s.thresholdMods;
            if(s.currentStatus) currentStatus = s.currentStatus;
            if(s.xpData) xpData = s.xpData;
            if(s.xpHistory) xpHistory = s.xpHistory;
            if(s.xpLog) xpLog = s.xpLog;
            if(s.skillRanks) skillRanks = s.skillRanks;
            updateMorality(s.morality || 50);
            updateGeneratorUI();
        } catch (e) { console.error("Error loading:", e); } finally { isSaveReady = true; }
    }

    const originalUpdateUI = updateGeneratorUI;
    updateGeneratorUI = function() { renderXPLogDisplay(); originalUpdateUI(); saveSession(); };

    document.getElementById('char-name').addEventListener('input', saveSession);
    document.getElementById('morality-val').addEventListener('input', () => { updateMorality(document.getElementById('morality-val').value); saveSession(); });
    window.addEventListener('click', (e) => { const m = document.getElementById('avatar-menu'); if (m && !m.classList.contains('hidden') && !e.target.closest('#avatar-display')) m.classList.add('hidden'); });
    
    const originalOnLoad = window.onload;
    window.onload = function() { if(originalOnLoad) originalOnLoad(); setTimeout(loadSession, 100); };
</script>
</body>
</html>